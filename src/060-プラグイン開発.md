# プラグイン開発による対象メトリックの追加

Mackerelの特徴の一つとして、プラグインを開発することによる、
カスタムメトリクスやチェック監視の追加が容易な事があげられます。

mackerel-agentとプラグインの間は、プラグインとして実行したコマンドの
返り値および標準出力によって結果の受け渡しを行う事ができます。

このため、特定のプログラミング言語に依存せずににプラグインの実装を行う事ができます。Mackerelの公式プラグインはGo言語で実装されていますが、
Rubyやシェルスクリプトなど、コマンドの返り値と標準入出力の概念を有しているプログラミング言語であればどれでも可能です。

特定のプログラミング言語に依存せずにプラグインの実装を行う事ができることのメリットは、現場の技術者が有しているスキルセットを活用してプラグインの
開発を行う事ができることです。

ITサービスの運用の現場では使用できる技術セットに限りがあります。

現場によって使用できる技術セットは、「シェルスクリプトならできる」「RubyならServerspecを使っているからわかる」など、現場ごとにばらつきがあります。

このことは運用に従事する技術者がにソフトウェア技術者でない以上避けられないことです。また運用のために構築するスクリプトは、ビジネス価値に直結する
プロダクションコードでないです。サービス構築は目的でなく手段である以上、
学習コストとコストに対するリターンの観点は必要でしょう。

このような時に、Mackerelの場合は、新しい技術セットを導入することなしに
現場が持っている技術セットを活用してサービス監視のために必要な構築プロセスを進めることができます。



## プラグインによる死活監視

```
#!/bin/bash
 
set -ux
 
FILE=/var/lib/mackerel-agent/jira
if [ -f ${FILE} ]; then
  COUNT=$(cat ${FILE})
else
  COUNT=0
fi
 
OUT=$(curl -f http://localhost:8080 2>&1)
 
RET=$?
 
if [ $RET -eq 0 ]; then
  echo 0 > ${FILE}
  exit 0
else
  echo $OUT
  COUNT=$(( COUNT + 1 ))
  echo ${COUNT} > ${FILE}
fi
 
if [ $COUNT -gt 10 ]; then
  echo $OUT
  rm -f ${FILE}
  PID=$(ps aux |grep java |grep Bootstrap |grep jira |awk '{print $2}')
  kill -9 $PID
  systemctl start jira
  exit 2
fi
exit 1
```