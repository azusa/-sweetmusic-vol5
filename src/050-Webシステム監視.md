# MackerelによるWebシステム監視

この章では、アトラシアン社のJira Software(以降Jira)とバックエンドにPostgreSQLを
使用したシステムを題材として、MackerelによるWebサービスの監視の例について述べます。


## 公式プラグインのセットアップ

Mackerelでは、各種ミドルウェアに対応した公式のプラグインが
オープンソースで^[[https://github.com/mackerelio/mackerel-agent-plugins](https://github.com/mackerelio/mackerel-agent-plugins)]提供されています。

インストールは、使用している環境に応じてyumレポジトリーないし
aptレポジトリーを使用します。mackerel-agentのセットアップ時に
スタートガイドに従って進めていれば、レポジトリーの設定は
行われていた状態になっています。

CentOSでのyumコマンドによる公式プラグインのインストール方法は、以下の通りと
なります。

```
sudo yum install mackerel-agent-plugins
```

## mackerel-plugin-jvmによるJVMの監視

Mackerelでは、`/etc/mackerel-agent/mackerel-agent.conf` にプラグインの設定を記述します。

mackerel-agent.confでは、TOMLという書式を使って、設定を記述します。

TOMLは、GitHubの共同創設者であるThomas Preston-Werner氏が提唱した 
設定ファイルの記述フォーマットで、「Tom's Obvious, Minimal Language」の略です。



`mackerel-agent.conf`の48行目近辺にJVMの監視である`mackerel-plugin-jvm`のための記述が
コメントされているので、これを編集します。

```
# [plugin.metrics.jvm]
# command = "mackerel-plugin-jvm -javaname=<required>"
```

javanameとは、`jps`コマンドを実行してホスト上で起動している
JVMのプロセス一覧を出力する際にプロセスを識別するもので、
通常はmainメソッドを実行しているクラスのクラス名が出力されます。

javanameに設定する値を知るには、ログインユーザー以外で
起動しているjavaプロセスも出力するために`sudo`をつけて`jps`コマンドを
実行します。

```
sudo jps -v |grep -v Jps
```

`jps`コマンドの出力は以下の通りです。この出力の`BootStrap`がjavanameになります。

```
$ sudo jps -v |grep -v Jps
9949 Bootstrap -Djava.util.logging.config.file=/opt/atlassian/jira/current/conf/logging.properties -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Xms884m -Xmx1268m -javaagent://usr/local/jolokia/jolokia-jvm-1.3.7-agent.jar -Djava.awt.headless=true -Datlassian.standalone=JIRA -Dorg.apache.jasper.runtime.BodyContentImpl.LIMIT_BUFFER=true -Dmail.mime.decodeparameters=true -Dorg.dom4j.factory=com.atlassian.core.xml.InterningDocumentFactory -XX:-OmitStackTraceInFastThrow -Djira.home=/var/atlassian/application-data/jira -Datlassian.plugins.startup.options= -Djdk.tls.ephemeralDHKeySize=2048 -Djava.protocol.handler.pkgs=org.apache.catalina.webresources -Xloggc:/opt/atlassian/jira/current/logs/atlassian-jira-gc-%t.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=20M -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCTimeStamps -XX:+PrintGCCause -Dcatalina.base=/opt/atlassian/jira/current -Dcatalina.home=/opt/atlassian/jira/current -Djava.io.tmpdir=/opt/atlassian/jira/current/temp
```


`mackerel-plugin-jvm` ではJVMのメトリックを収集するために
`jps` `jinfo` `jstat` のコマンドを使用します。起動している
JVMと同じインストール先のコマンドを使用するため、`alternatives`
コマンドを使用して設定を行います。

```
sudo alternatives --set java /usr/java/jdk1.8.0_162/bin/java
sudo alternatives --set javac /usr/java/jdk1.8.0_162/bin/javac
```

サービスのjavaプロセスが`/usr/bin/java` のシンボリックリンクが差す
JDKと異なるJDKで起動している場合は、
`-jstatpath` `-jpspath` `-jinfopath`オプションでコマンドへのパスを指定します。

```
command = "/usr/local/bin/mackerel-plugin-jvm -javaname=Bootstrap -jstatpath=/usr/lib/jvm/java-1.8.0/bin/jstat -jpspath=/usr/lib/jvm/java-1.8.0/bin/jps -jinfopath=/usr/lib/jvm/java-1.8.0/bin/jinfo"
```

## PostgreSQLの監視

あああ...