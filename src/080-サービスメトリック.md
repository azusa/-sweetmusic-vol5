\lhead[]{}
\rhead[]{}
\chead[サービスメトリック]{サービスメトリック}

# サービスメトリック

アプリケーションのメトリックや、売上やページビューなどのビジネス指標等、特定のホストに関連付かない
メトリックをMackerelではサービスメトリックと呼称します。

サービスメトリックは、Mackerelが提供しているAPIにhttpでPOSTすることによって行います。

```
 curl -v https://api.mackerelio.com/api/v0/services/techbookfest/tsdb \
 -H 'X-Api-Key: <APIキー>' \
 -H 'Content-Type: application/json' -X POST \
 -d '[{"name": "circleCheck", "time": '$(date +%s)', "value": 16}]'
```

### APIのドメイン

MackerlのAPI呼び出しのドメインは`api.mackerelio.com`です。これは、当初は`mackerel.io`を
使用していたものが、`.io`ドメインの権威DNSサーバーの不調に伴うサービスへの影響 ^[[https://mackerel.io/ja/blog/entry/announcement/20170921](https://mackerel.io/ja/blog/entry/announcement/20170921)]を受けて、`api.mackerelio.com`に変更になったもの ^[[https://mackerel.io/ja/blog/entry/weekly/20171006](https://mackerel.io/ja/blog/entry/weekly/20171006)]です。


次に示すのは、Azure FunctionsのTimerTriggerを使用して、技術書典のサークルの被チェック数を
取得してMackerelにサービスメトリックとして送信するTypeScriptのスクリプトです。

```{#lst:code080code02 caption="サービスメトリックの投稿"}
const client = require('cheerio-httpcli')
const tough = require('tough-cookie')
const rp = require('request-promise')

const email = process.env.EMAIL
const password = process.env.PASSWORD
const apiKey = process.env.MACKEREL_API_KEY

export async function run (context: any, mytimer: any) {
  const checkedCount = await sendCheckedcountToSlack()
  console.log(new Date().toLocaleString(), checkedCount)
  context.done();
};

const fetchCheckedCount = async userToken => {
  const cookie = new tough.Cookie({
    key: 'user',
    value: userToken,
    path: '/',
    domain: 'techbookfest.org'
  })
  const jar = rp.jar()
  jar.setCookie(cookie, 'https://techbookfest.org')
  const opt = {
    url: 'https://techbookfest.org/api/circle/own',
    jar
  }
  const circles = JSON.parse(await rp(opt))
  const checkedCount = circles.filter(circle => circle.event.id === 'tbf04').map(circle => circle.checkedCount)[0]
  return checkedCount
}

const re = /^user=([^;]+)/

const signIn = async () => {
  const opt = {
    method: 'POST',
    uri: 'https://techbookfest.org/api/user/login',
    body: JSON.stringify({ email, password }),
    headers: {
      'content-type': 'application/json'
    },
    resolveWithFullResponse: true
  }
  const res = await rp(opt)
  const matched = re.exec(res.headers['set-cookie'][0])
  return matched[1]
}

const crawl = async () => {
  const userToken = await signIn()
  const checkedCount = await fetchCheckedCount(userToken)
  return checkedCount
}

const sendToMackerel = async checkedCount => {
    const opt = {
        method: 'POST',
        uri: 'https://api.mackerelio.com/api/v0/services/techbookfest/tsdb',
        body: JSON.stringify([{ name: "circleCheck", time: Math.floor(new Date().getTime() / 1000), value: checkedCount }]),
        headers: {
          'content-type': 'application/json',
          'X-Api-Key': apiKey
        },
        resolveWithFullResponse: true
      }
    await rp(opt)
}

const sendCheckedcountToSlack = async () => {
  const checkedCount = await crawl()
  await sendToMackerel(checkedCount) 
  return checkedCount
}

```
