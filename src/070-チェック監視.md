# チェック監視について

あああ..

## ログの監視

## メトリック監視とチェック監視

## check-httpプラグインによる死活監視

```
[plugin.checks.jira]
command = "check-http -u http://localhost:8080/"
check_interval = 3
action = { command="/usr/local/bin/restart-jira.sh" }
```

ブロックの先頭の`[plugin.checks.jira]`がMackerel上で監視項目を識別する
キーになります。チェック監視の場合は、キー名は`plugin.checks`ではじまり、
含まれるドットの数は2つである(三階層)である必要があります。

チェック監視の場合は、action項目で、監視の閾値の条件に該当する際に、
実行するコマンドを記述することができます。以下は、この機能を使って、
httpのヘルスチェックに失敗した際にサービスの自動再起動を行うサンプルです。

```
#!/bin/bash

if [ -z $MACKEREL_STATUS ]; then
  exit 0
fi

if [ -z $MACKEREL_PREVIOUS_STATUS ]; then
  exit 0
fi


set -ux
set +e


if [ $MACKEREL_PREVIOUS_STATUS = "CRITICAL" -a $MACKEREL_STATUS = "CRITICAL" ]; then
  PID=$(ps aux |grep java |grep Bootstrap |grep jira |awk '{print $2}')
  kill -9 $PID
  systemctl start jira
fi
```

環境変数の`MACKEREL_PREVIOUS_STATUS`と`MACKEREL_STATUS`にチェック監視の結果が格納されています。
この例では、`MACKEREL_PREVIOUS_STATUS`と`MACKEREL_STATUS`がともに`CRITICAL`の場合にサービス再起動を行いますので、
2回連続でヘルスチェックの実行に失敗した場合にサービスの自動再起動を行うことになります。

再起動している間もヘルスチェックは継続しているので、`check_interval`で定義された
次のチェックまでの間隔(この場合3分)までにサービスの起動が完了している必要があります。



## チェック監視の復旧報
