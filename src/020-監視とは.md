\lhead[]{}
\rhead[]{}
\chead[監視とは]{監視とは}

# なぜゆえの監視

平家物語の歌い出しに「諸行無常の響きあり」という言い回しがありますが、
どれだけ完璧なサイジングをしたとしても、ITサービスを取り巻く周囲の環境の
変化は、サーバーやネットワーク帯域などのインフラのレイヤーに様々な
影響を及ぼし、パフォーマンスの低下やレイテンシーの増大など、サービス品質に影響を与える問題を引き起こします。

ITサービス運用を考えるにあたって、ユーザーは増えるものであり、データは貯まるものであり、アプリケーションの規模は膨らむものです。

現代では、クラウドに代表される仮想化技術の進展により、インフラに関する
リソースは以前に比べるとはるかに容易に調達ができるようになってきました。しかし、インフラにかかるコストと事業の収益性は比例するものではないということを考えると、インフラにかかる費用を制限なく青天井で計上するということもまた非現実的です。

情報処理の世界には「Measure Don't Guess.」(推測するな、計測せよ)や、「計測なくして改善なし」などの格言がありますが、これらの言葉の根底には19世紀のフランスの数学者Jules-Henri Poincarの「計測なくして科学なし」という言葉があります。

パフォーマンスチューニングとは測定した事象と仮説検証について行う、れっきとしたエンジニアリングの一分野であり、単に「設定値を増やせばいい」というものではありません。ネットワークを通じて結びつく、ITサービスを構成するシステム上の各機器のパラメーターを調整する上では、個別の機器のパラメーターの変動がシステム全体にどのような影響を及ぼすかという視点が必要です。

そのためには、システムのリソースの使用状況や、プログラム実行時のエラーの状況など、サービスの可用性に関連のある項目を時系列に沿って集積し、適切な監視を行う必要があります。

## 誰のためのモニタリング

ITサービスの運用に当たっては開発、インフラ構築、運用など、様々な利害関係者が存在します。その中で運用に関わる主体は、システムを安定して運用することを使命としています。

システムインテグレーションの分野では、開発が完了してカットオーバーされてもユーザーがいないシステムというものが間々ありますが、これは運用の立場からすると、理想的なシステムです。なぜなら、ユーザーがいないシステムはユーザーへのサービス提供に影響をおよぼす障害をおこすことがないからです。

これは極端な例ですが、自らのタスクがキューからあふれているシステム運用者は、「システムをいかに使用させないか」という思考パターンに陥ることがあります。

しかし、ITサービスの構成要素としてのシステムはユーザーの使用に供するために存在するということであり、その意味では、アラームが発生するということは、システムが使われて社会のために役に立っていると言うことの証明です。

DevOpsという概念を広く世に知らしめた「10+ Deploys Per Day」[@Allspaw2009] では「Opsの仕事は、ビジネスを実現することだ」 (Ops' Jobs is to enable the business) と示されています。ITサービス運用の存在意義は、システムの安定運用を通じてビジネス価値を実現することと、サービスを取り巻く環境の変化に対応するために、柔軟なインフラ基盤の提供を実現することにあります。

しかしながら、ITサービス運用というのはシステムを作る側でなく預かる側です。運用(インフラ)が仕事がないことは望ましいことです。実際運用が暇で時間を持て余すくらいでないと、安定運用のための足場づくりというのは不可能です。ですが「システムの使用を促進する」ことと、「自分の仕事を減らす」という二点を両立させることは、言うは易く行うは難しの最たる例です。

システムの安定運用と、運用業務の省力化の二つの観点の最適化という観点から監視を考えた場合に留意すべき事は、監視の項目の粒度は、詳細にしようとすればいくらでも細かくできるということです。

ハードウェアのリソースやOSのモジュールの動作状況、ネットワークの使用状況など、監視する項目は際限なく増やすことができます。発生確率が一定という条件の下では、監視項目が増えるということはアラームが発生する回数が増えるということです。

そして発生するアラームを受けるのはシフトで夜勤をしている運用メンバーです。そしてアラームを受け取ることから始まるストレスと負のフィードバックはやがてDevとOpsの対立を引き起こします。

監視をすることその事態は目的ではなく、安定したサービス運用のために手段として行うものです。我々はサービスの監視を行いたいわけであってOSの監視を行いたいわけではないです。

その際の監視の対象の主となるものは、ユーザーに対するサービス提供が正常かどうかであり、ハードウェアやOS、そしてアプリケーションの細かい状態への監視はそれを補完するものです。

## 監視にもとめられるもの

以上のことを踏まえた上で、監視を行うシステムに求められるものを、以下にあげます。

### 最小限度のカスタマイズで使用することができること

また仮想化技術の進展により、一つのサービスを構成する上でのサーバーやネットワーク機器等の構成要素が
増えていく中で、必要最小限の監視項目を構成する上でカスタマイズによる作り込みの要素が大きいミドルウェアやサービスは適当ではありません。

OSやミドルウェアの詳細なメトリックなど、監視を行う要素はいくらでも細かくすることができますが、
ITサービスの構築プロジェクトの納期が短縮の傾向を見せている昨今。詳細な監視項目の作り込みは
構築プロジェクトの大半の期間をカスタマイズで終わらせることになりかねません。

## 機能と学習コストのバンスがとれていること

「学習コスト」という概念は、得てして組織が技術水準の向上に投資をしないことへの正当化として用いられがちですが、
ITサービス運用において監視とは手段の位置づけであり、監視の構築と運用のために組織にその専門家を
必要とするような状況は本末転倒です。
ITサービス運用での業務を最適化するうえでは学習コストとコストに対するリターンの観点は必要でしょう。

### 既定値のバランスがとれていること

先ほどの「最小限度のカスタマイズで使用することができること」をサービスの既定値の視点から見れば、
カスタマイズを最小限度に抑えるため、セットアップ直後の規定値がバランスが取れたものとなっていることが求められます。

以上を踏まえて、本書では上記を実現するための方策として、サーバー監視サービスであるMackerelを紹介します。




